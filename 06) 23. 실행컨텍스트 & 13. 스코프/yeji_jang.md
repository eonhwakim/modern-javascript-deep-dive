# 13.스코프

## 1.스코프란?
- 스코프는 식별자가 유효한 범위를 말한다. 
- 모든 식별자(변수 이름, 함수 이름, 클래스 이름 등)는 자신이 선언된 위치에 의해 다른 코드가 식별자 자신을 참조할 수 있는 유효 범위가 결정되는 것.
-  식별자를 검색할 때 사용하는 규칙이라고도 함.

```js
var x = 'global';

function foo() {
  var x = 'local';
  console.log(x); // local
}

foo();
console.log(x); // global
```

- 자바스크립트 엔진은 같은 두 개의 변수 중에서 어떤 변수를 참조해야 할 것인지를 스코프를 통해 결정한다.
- 이를 `식별자 결정`이라 하고, 스코프란 식별자를 검색할 때 사용하는 규칙이라고도 할 수 있다.
- 만약 스코프라는 개념이 없다면 같은 이름을 갖는 변수는 충돌을 일으키므로 프로그램 전체에서 하나밖에 사용할 수 없다.

- 식별자는 어떤 값을 구별해야 하므로 유일해야 한다. 
- ***따라서 변수 이름은 중복될 수 없다.***
- 이를 위해 프로그래밍 언어에서는 스코프를 통해 식별자인 변수 이름의 충돌을 방지하여 같은 이름의 변수를 사용할 수 있게 한다.

## 2.스코프의 종류
`전역 변수`
- 코드 가장 바깥의 영역, 전역 스코프

`지역 변수`
- 함수 몸체 내부의 영역, 지역 스코프

#### 1) 전역과 전역 스코프
- 전역이란 코드 가장 바깥의 영역을 말하고 전역 변수는 어디서든지 참조할 수 있다.

#### 2) 지역과 지역 스코프
- 지역이란 함수 몸체 내부를 말하고 지역 변수는 자신의 지역 스코프와 하위 지역(중첩 함수) 스코프에서 유효하다.

## 3.스코프 체인
- 함수의 중첩에 의해 계층적인 구조를 가지게 되어 스코프가 계층적으로 연결된 것을 스코프 체인이라 한다.

- 변수를 참조할 때 자바스크립트 엔진은 스코프 체인을 통해 변수를 참조하는 코드의 스코프에서 시작하여 상위 스코프 방향으로 이동하며 선언된 변수를 검색한다.

- 스코프 체인으로 연결된 스코프의 계층적 구조는 부자 관계로 이뤄진 상송과 유사하다. 
- 상속을 통해 부모의 자산을 자식이 자유롭게 사용할 수 있지만 자식의 자산을 부모가 사용할 수는 없다.

## 4.함수 레벨 스코프
- 함수 레벨 스코프는 오로지 함수의 코드 블록 만을 지역 스코프로 인정하는 것이다.

- 블록 레벨 스코프는 함수 몸체만이 아니라 모든 코드 블록 등이 지역 스코프를 만드는 것이다. 
- if, for, while try/catch 등의 코드 블록은 블록 레벨 스코프를 만든다.

```js
var x = 1;

if (true) {
  // var 키워드로 선언된 변수는 함수의 코드 블록(함수 몸체)만을 지역 스코프로 인정한다.
  // 함수 밖에서 var 키워드로 선언된 변수는 코드 블록 내에서 선언되었다 할지라도 모두 전역 변수다.
  // 따라서 x는 전역 변수다. 이미 선언된 전역 변수 x가 있으므로 x 변수는 중복 선언된다.
  // 이는 의도치 않게 변수 값이 변경되는 부작용을 발생시킨다.
  var x = 10;
}

console.log(x); // 10
```

- var 키워드로 선언된 변수는 함수 레벨 스코프만 인정하기 때문에 코드 블록 내에서 선언되었다 할지라도 전역 변수이다.
- 만일 var키워드로 선언된 변수가 블록 레벨 스코프를 인정했다면 1이 출력되었을 것이다.

***ES6에서 도입된 let, const 키워드는 블록 레벨 스코프를 지원한다.***

## 5.렉시컬 스코프
- 동적 스코프는 함수를 어디서 호출했는지에 따라 함수의 상위 스코프를 결정하는 것, 렉시컬 스코프는 함수를 어디서 정의했는지에 따라 함수의 상위 스코프를 결정하는 것을 말한다.

```js
var x = 1;

function foo() {
  var x = 10;
  bar();
}

foo(); // ?

bar = function() {
  console.log(x);
}

bar(); // ?
```
- 자바스크립트는 렉시컬 스코프를 따르므로 함수가 어디서 정의되었는지에 따라 상위 스코프를 결정한다.
- 따라서 위서는 둘 다 1을 출력한다.

# 23.실행컨텍스트

## 23.1 소스코드의 타입

- ECMAScript 사양은 실행 컨텍스트를 생성하는 소스 코드를 총 4가지 타입으로 구분한다. 다음의 소스코드 타입에 따라 실행 컨텍스트를 생성하는 과정과 관리 내용이 다르다.

`전역코드`
- 전역에 존재하는 소스코드
`함수코드`
- 함수 내부에 존재하는 소스코드
`eval 코드`
- eval 함수의 인수로 전달되어 실행되는 소스코드
`모듈코드`
- 모듈 내부에 존재하는 소스코드

## 23.3 소스코드의 평가와 실행

- 자바스크립트 엔진은 소스코드를 평가와 실행이라는 두 개의 과정으로 나누어 처리한다.

`소스코드 평가 과정`

   실행 컨텍스트가 생성된다.
-> 변수, 함수 등 각 식별자에 대한 선언문들이 실행된다.
-> 선언문이 실행되면 해당하는 렉시컬 환경 내 환경 레코드에 등록된다.
-> var 키워드로 선언한 식별자에 해당하는 값은 undefined로 초기화 되며 함수 선언문으로 선언한 식별자의 값은 실제 함수 몸체를 담고 있는 함수 객체로 초기화 된다.
-> let, const, class 키워드로 선언한 식별자에 대해서는 초기화를 하지 않는다.

`소스코드 실행 과정`

   평가 과정이 끝나면 이미 실행된 코드(선언문 등)를 제외한 소스코드가 순차적으로 실행된다.
-> 실행 과정에서 특정 식별자의 값을 참조할 경우 스코프에서 검색한다.

## 23.3 실행 컨텍스트의 역할

- 실행 컨텍스트는 코드를 실행하는 환경을 제공하고 관리한다. 
- 소스코드는 여러 타입으로 나뉘긴하지만 본질적으로 명령과 상태의 집합이다. 
- 실행 컨텍스트는 명령과 상태를 관리할 수 있는 방법을 제공한다. 
- 실행 컨텍스트는 렉시컬 환경과 외부 렉시컬 환경 참조를 통해 스코프와 스코프 체인을 형성한다.
- 또한 실행 컨텍스트는 콜 스택에 의해 실행 순서를 보장받는다. 

## 23.4 실행 컨텍스트 스택

- 코드 평가를 통해 생성한 실행 컨텍스트는 스택 자료구조로 관리된다. 
- 이를 콜스택(또는 실행 컨텍스트 스택)이라고 부른다. 콜스택은 각 코드의 실행 순서를 관리한다. 
- 가령 코드를 실행하는 중에 함수 호출부를 만나면 기존 실행을 멈추고 함수를 실행한다. 이때, 함수의 실행이 끝나면 다시 원래 코드로 돌아가서 순차적으로 실행해야한다.
- 콜 스택에는 실행 컨텍스트가 생성되는 순서대로 담기고 항상 최상단에 있는 컨텍스트가 실행된다. 
- 컨텍스트의 생명주기가 끝나면 바로 스택에서 제거되는데 이때, 그 컨텍스트를 생성했던 실행 컨텍스트가 최상단에 위치하게 되므로 바로 직전의 코드로 돌아갈 수 있다.

## 23.5 렉시컬 환경

- 렉시컬 환경은 실행 컨텍스트의 구성 요소이다. 
- 렉시컬 환경은 환경 레코드와 외부 렉시컬 환경 참조로 구성되어 있다. 
- 환경 레코드에는 식별자와 그 식별자에 바인딩 된 값이 키, 값 형태로 등록, 관리된다. this에 대한 정보도 바로 이 환경레코드에 저장된다. 
- 외부 렉시컬 환경 참조에는 상위 스코프에 대한 참조가 담긴다. 여기서 말하는 상위 스코프란 해당 실행 컨텍스트를 생성한 코드를 포함하는 코드의 렉시컬 환경을 의미한다. 
- 이때 외부 렉시컬 환경 참조를 통해 전역 실행 컨텍스트까지 이어지는 단방향 링크드 리스트가 형성되는데 이를 스코프 체인이라 부른다.

## 23.6 실행 컨텍스트의 생성과 식별자 검색 과정


  `전역 객체 생성`
- 전역객체는 전역 코드가 평가되기 이전에 생성된다.
- 전역 객체는 동작 환경에 따라 다르게 생성되며 각각 다른 호스트 객체를 포함한다.
- 전역 코드 평가
- 전역 실행 컨텍스트 생성
- 전역 실행 컨텍스트콜스택에 넣음
- 전역 렉시컬 환경 생성
- 전역 렉시컬 환경을 생성하고 전역 실행 컨텍스트에 연결한다.(전역 실행 컨텍스트 안에 있는 렉시컬 환경 컴포넌트가 이를 참조한다.)
- 전역 환경 레코드를 생성 
- 객체 환경 레코드는 var와 함수 선언문으로 선언한 식별자와 빌트인 전역 프로퍼티, 빌트인 전역 함수, 표준 빌트인 객체를 관리
- 객체 환경 레코드 안에는 BindingObject라고 하는 요소가 존재한다.
- BindingObject는 전역 객체에 대한 참조를 담고 있다.
- var, 함수 선언문을 통해 선언된 식별자는 BindingObject를 통해 전역 객체의 프로퍼티 및 메서드가 된다.
- 선언적 환경 레코드는 let, const 키워드로 선언한 전역 변수를 관리한다.
- 선언적 환경 레코드는 개념적인 블록의 역할을 수행한다.
- GlobalThisValue가 바인딩 된다. 일반적으로 전역 객체가 바인딩 되며 전역 코드상에서 this를 참조하면 전역 환경 레코드의 GlobalThisValue가 참조하는 객체를 반환한다.<br>
`외부 렉시컬 환경 참조 결정`
- 외부 렉시컬 환경은 렉시컬 환경의 구성 요소이며 상위 코드(해당 실행 컨텍스트를 생성한 코드를 포함하는 코드)의 렉시컬 환경을 참조를 담고 있다.
- 전역 렉시컬 환경의 외부 렉시컬 환경 참조에는 null이 할당 된다.<br>
`전역 코드 실행`
- 전역 코드를 순차적으로 실행한다.
- 식별자에 대한 참조가 있을 경우 렉시컬 환경 내에서 검색한다.
- 실행 중 함수 호출부를 만나면 실행을 멈추고 함수의 코드를 평가 및 실행한다.<br>
`함수 코드 평가`
- 함수 실행 컨텍스트 생성
- 함수 렉시컬 환경 생성
- 함수 환경 레코드를 생성한다.
- 함수 환경 레코드는 매개변수, arguments 객체, 함수 내 식별자를 등록, 관리한다.
- ThisValue가 바인딩 된다. ThisValue는 함수 내에서 this 참조 시 반환하는 객체를 담고 있는 내부 슬롯이다.
- ThisValue의 값은 함수 호출 방식에 따라 결정된다.(22장 this 관련 내용 참고)
`외부 렉시컬 환경 참조 결정`
- 자바스크립트 엔진이 함수 객체를 생성할 때 생성 당시 실행 중인 컨텍스특의 렉시컬 환경을 내부 슬롯 [[Environment]]에 저장한다.
- 함수 렉시컬 황경의 외부 렉시컬 환경 참조에 [[Environment]]가 할당 된다.<br>
`함수 코드 실행`
- 식별자에 대한 참조가 있을 경우 렉시컬 환경 내에서 검색한다.
- 렉시컬 환경에 식별자 정보가 없다면 외부 렉시컬 환경 참조를 따라 상위 렉시컬 환경을 탐색한다.<br>
`코드 실행 종료`
- 함수 또는 전역 코드의 실행이 종료되면 해당하는 실행 컨텍스트가 콜스택에서 제거

## 23.7 실행 컨텍스트와 블록 레벨 스코프

- ES6에서 추가된 let, const 키워드의 경우 블록 레벨 스코프를 지원한다. 
***그렇다면 실행 컨텍스트 내에서 어떻게 블록 레벨 스코프를 지원할 수 있을까?***
- 코드 실행 중 블록문({})을 만나면 선언적 환경 레코드를 갖는 렉시컬 환경(블록 렉시컬 환경)을 새롭게 생성하고 실행 컨텍스트에 있는 렉시컬 환경 컴포넌트가 이를 참조하도록 한다. 
- 이때 새롭게 생성된 블록 렉시컬 환경은 기존 렉시컬 환경을 참조하는 외부 렉시컬 환경 참조를 갖는다. 
- 코드 블록의 실행이 종료되면 블록 렉시컬 환경이 가지고 있는 외부 렉시컬 환경 참조를 이용해 실행 컨텍스트의 렉시컬 환경 컴포넌트가 기존 렉시컬 환경을 다시 참조하도록 원상 복구한다.

